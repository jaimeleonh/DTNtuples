//#include "tdrstyle.C"
#include "TH1.h"
#include "TH2.h"
#include <TStyle.h>
#include <TCanvas.h>
#include "TGraph.h"
#include "TCanvas.h"
#include "TAxis.h"
#include "TStyle.h"
#include "TLegend.h"
#include "TEfficiency.h"
#include "PlotTemplate.C"

/*
double getMeanEfficiency ( std::string effPlot, TString file ) {
  TFile data1(file);
  cout << file << endl;
  char name[128];
  sprintf(name,"%s",effPlot.c_str());
  TEfficiency *plot = (TEfficiency*) data1.Get(name);
  cout << effPlot << endl;

  for (unsigned int i = 1; i<=plot->GetPaintedGraph()->GetXaxis()->GetNbins(); i++){
    cout << plot->GetPaintedGraph()->GetXaxis()->GetBinCenter(i); 
  }
}
*/

double getMeanEfficiency(TH1 *plot1, TH1 *plot2, double initialVal, double finalVal){
  double sumPassed = 0.;
  double sumTotal  = 0.;
  for (unsigned int i = 1; i<=plot1->GetXaxis()->GetNbins(); i++){
     if ( plot1->GetXaxis()->GetBinCenter(i) < initialVal || plot1->GetXaxis()->GetBinCenter(i) > finalVal  ) continue; 
     sumPassed = sumPassed + plot1->GetBinContent(i); 
     sumTotal  = sumTotal  + plot2->GetBinContent(i); 
  //   cout << plot1->GetXaxis()->GetBinCenter(i) << " " <<sumPassed << "/" << sumTotal << endl;  
  }
  
  return sumPassed/sumTotal;
}

void printPlots_run(std::string run) {

  const bool fileOK = false; 

  gStyle->SetOptStat(111111);
  std::vector<std::string> stuffTags = {"Time", "Pos", "Psi"};

  TString runNumber = run; 
  TString file = "results_run" + runNumber + ".root";
  gSystem->Exec("mkdir run" + runNumber);

  TFile data1(file);
  
  TString Lumi = "35.9";
  
  int a = 0;

  std::vector<std::string> chambTags = {"MB1", "MB2","MB3", "MB4"};
  //std::vector<std::string> chambTags = { "MB2","MB3", "MB4"};
  std::vector<std::string> slTags = { "SL1", "SL3"};
  std::vector<std::string> quTags = {"3h","4h","Q6","Q7","Q8"};
  std::vector<std::string> quTagsSegs = {"3h","4h","Q6","Q7","Q8","bestQ"};
  std::vector<std::string> labelTags = {"All", "Correlated", "Uncorrelated"};
  std::vector<std::string> labelTagsPlots = {"All", "Correlated", "Uncorrelated", "UncorrelatedSL1", "UncorrelatedSL3"};
  
  std::map<std::string, TH1*> m_plots;
  std::map<std::string, TH2*> m_plots2;
  std::map<std::string, TEfficiency*> m_effs;

  char name [128];

  std::vector <std::string> categories {"perGroup","perQuality"}; 

  std::vector <std::string> generalEffPlots {"hEffHW", "hEffTM", "hEffAM"};
  std::vector <std::string> effvsWhat = {"vsSegX","vsSegT0","vsph2SegX","vsph2SegT0","vsSegXLim","vsSegT0Lim","vsph2SegXLim","vsph2SegT0Lim"};
  std::vector <std::string> effWhichBX = {"","GoodBX"};  
  
  
  
  
  std::vector <std::string> general1DPlots {"hQualityHW", "hQualityAM", "Offset"}; 
//  std::vector <std::string> general1DPlots {"hQualityHW", "hQualityAM", "hBXDif"}; 
  std::vector <std::string> specific1DPlots {"hSLHW", "hSLAM", "hPrimsSegs","hQualityHW", "hQualityAM", "hQualityTM", "hBXTM", "hLatenciesHW", "hBXWindowHW", "hMultiplicityHW"};
  std::vector <std::string> specific2DPlots {"hPrimTypeVsPos","h2DHwQualSegNHits","h2DEmuQualSegNHits","h2DTMQualSegNHits","hQualityVsBXHW", "hQualityVsBXAM", "hHits","hHitsVsLatenciesHW", "hQualityVsLatenciesHW", "hPositionVsHitsHW"};
  //std::vector <std::string> moreSpecific1DPlots { };
  std::vector <std::string> moreSpecific1DPlots {"hBX","hBXDif","hBXEmul","hBXDifEmul", "hPsiHW","hPsiEmul", "hPsi", "hTime","hPos"}; // "hChi2FW","hChi2Emul",
  std::vector <std::string> moreSpecific1DPlotsSegs {"hPsiSeg", "hTimeSeg","hPosSeg","hPsiph2Seg", "hTimeph2Seg","hPosph2Seg"};
  std::vector <std::string> moreSpecific2DPlots {"hPsi2D", "hTime2D","hPos2D","hPsi2DTM","hPos2DTM","hPhi2DTM","hPhiB2DTM"};
  std::vector <std::string> moreSpecific2DPlotsSegs {"hPsi2DSeg", "hTime2DSeg","hPos2DSeg", "hPsi2Dph2Seg", "hTime2Dph2Seg","hPos2Dph2Seg"}; 
	// "hTimeSegvsPos", "hTimeSegvsPsi","hTimeSegvsSegZ", "hTimeph2SegvsPos", "hTimeph2SegvsPsi", "hTimeph2Segvsph2SegZ"

  std::vector <std::string> axisAndUnits {"BX (BX units)", "BX (BX units)","BX (BX units)", "BX (BX units)", "FW chi2 (U.A)", "Emul chi2 (U.A)", "HW Psi (#circ)", " Phase-2 Emulator Psi (#circ)","Phase-2 Primitive -  Phase-2 Emulator Psi (#circ)", "Phase-2 Primitive -  Phase-2 Emulator Time (ns)", "Phase-2 Primitive - Phase-2 Emulator Position (cm)"};
  std::vector <std::string> axisAndUnitsSegs {"Phase-2 Primitive - Phase-1 Segment Psi (#circ)", "Phase-2 Primitive - Phase-1 Segment Time (ns)", "Phase-2 Primitive - Phase-1 Segment Position (cm)", "Phase-2 Primitive -  Phase-2 Segment Psi (#circ)", "Phase-2 Primitive -  Phase-2 Segment Time (ns)", "Phase-2 Primitive -  Phase-2 Segment Position (cm)" };

  std::map<std::string, TH1*> m_plots_res;
  std::map<std::string, TH1*> m_plots_mean;
  std::map<std::string, TH1*> m_plots_peak;

  for (auto & chambTag : chambTags) {
    for (int j = 0; j < moreSpecific1DPlots.size(); j++){
      auto specific1DPlot = moreSpecific1DPlots.at(j);
   
      m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(0)] = new TH1F((specific1DPlot + "_res_" + chambTag + "_" + categories.at(0)).c_str(), 
					    "Resolutions; ; Resolution (a.u.) ",
					    5,-0.5,4.5); 
      m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(0)] = new TH1F((specific1DPlot + "_mean_" + chambTag + "_" + categories.at(0)).c_str(), 
					    "Means; ; Mean (a.u.) ",
					    5,-0.5,4.5);
	  m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(0)] = new TH1F((specific1DPlot + "_peak_" + chambTag + "_" + categories.at(0)).c_str(), 
					    "Peak positions; ; Peak position (a.u.) ",
					    5,-0.5,4.5); 
      for (int i = 0; i < 5; i++){
        m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(0)]->GetXaxis()->SetBinLabel(i+1, labelTagsPlots[i].c_str());
        m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(0)]->GetXaxis()->SetBinLabel(i+1, labelTagsPlots[i].c_str());
		m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(0)]->GetXaxis()->SetBinLabel(i+1, labelTagsPlots[i].c_str());
      }
      
      m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(1)] = new TH1F((specific1DPlot + "_res_" +  chambTag + "_" + categories.at(1)).c_str(), 
					    "Resolutions; ; Resolution (a.u.) ",
					    5,-0.5,4.5); 
      m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(1)] = new TH1F((specific1DPlot + "_mean_" +  chambTag + "_" + categories.at(1)).c_str(), 
					    "Means; ; Mean (a.u.) ",
					    5,-0.5,4.5);
	  m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(1)] = new TH1F((specific1DPlot + "_peak_" + chambTag + "_" + categories.at(1)).c_str(), 
					    "Peak positions; ; Peak position (a.u.) ",
					    5,-0.5,4.5); 
      for (int i = 0; i < 5; i++){
        m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(1)]->GetXaxis()->SetBinLabel(i+1, quTags[i].c_str());
        m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(1)]->GetXaxis()->SetBinLabel(i+1, quTags[i].c_str());
		m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(1)]->GetXaxis()->SetBinLabel(i+1, quTags[i].c_str());
      }

      m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(0)]->GetYaxis()->SetTitle(axisAndUnits.at(j).c_str());
      m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(1)]->GetYaxis()->SetTitle(axisAndUnits.at(j).c_str());

      m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(0)]->GetYaxis()->SetTitle(axisAndUnits.at(j).c_str());
      m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(1)]->GetYaxis()->SetTitle(axisAndUnits.at(j).c_str());

      m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(0)]->GetYaxis()->SetTitle(axisAndUnits.at(j).c_str());
      m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(1)]->GetYaxis()->SetTitle(axisAndUnits.at(j).c_str());

    }
  }
  for (auto & chambTag : chambTags) {
    for (int j = 0; j < moreSpecific1DPlotsSegs.size(); j++){
      auto specific1DPlot = moreSpecific1DPlotsSegs.at(j);
   
      m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(0)] = new TH1F((specific1DPlot + "_res_" + chambTag + "_" + categories.at(0)).c_str(), 
					    "Resolutions; ; Resolution (a.u.) ",
					    5,-0.5,4.5); 
      m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(0)] = new TH1F((specific1DPlot + "_mean_" + chambTag + "_" + categories.at(0)).c_str(), 
					    "Means; ; Mean (a.u.) ",
					    5,-0.5,4.5);
      m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(0)] = new TH1F((specific1DPlot + "_peak_" + chambTag + "_" + categories.at(0)).c_str(), 
					    "Peak positions; ; Peak position (a.u.) ",
					    5,-0.5,4.5); 
      for (int i = 0; i < 5; i++){
        m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(0)]->GetXaxis()->SetBinLabel(i+1, labelTagsPlots[i].c_str());
        m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(0)]->GetXaxis()->SetBinLabel(i+1, labelTagsPlots[i].c_str());
		m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(0)]->GetXaxis()->SetBinLabel(i+1, labelTagsPlots[i].c_str());
      }
      
      m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(1)] = new TH1F((specific1DPlot + "_res_" +  chambTag + "_" + categories.at(1)).c_str(), 
					    "Resolutions; ; Resolution (a.u.) ",
					    6,-0.5,5.5); 
      m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(1)] = new TH1F((specific1DPlot + "_mean_" +  chambTag + "_" + categories.at(1)).c_str(), 
					    "Means; ; Mean (a.u.) ",
					    6,-0.5,5.5);
      m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(1)] = new TH1F((specific1DPlot + "_peak_" + chambTag + "_" + categories.at(1)).c_str(), 
					    "Peak positions; ; Peak position (a.u.) ",
					    6,-0.5,5.5); 
      for (int i = 0; i < 6; i++){
        m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(1)]->GetXaxis()->SetBinLabel(i+1, quTags[i].c_str());
        m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(1)]->GetXaxis()->SetBinLabel(i+1, quTags[i].c_str());
		m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(1)]->GetXaxis()->SetBinLabel(i+1, quTags[i].c_str());
      }

      m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(0)]->GetYaxis()->SetTitle(axisAndUnitsSegs.at(j).c_str());
      m_plots_res[specific1DPlot + "_res_" + chambTag + "_" + categories.at(1)]->GetYaxis()->SetTitle(axisAndUnitsSegs.at(j).c_str());

      m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(0)]->GetYaxis()->SetTitle(axisAndUnitsSegs.at(j).c_str());
      m_plots_mean[specific1DPlot + "_mean_" + chambTag + "_" + categories.at(1)]->GetYaxis()->SetTitle(axisAndUnitsSegs.at(j).c_str());
	  
	  m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(0)]->GetYaxis()->SetTitle(axisAndUnitsSegs.at(j).c_str());
      m_plots_peak[specific1DPlot + "_peak_" + chambTag + "_" + categories.at(1)]->GetYaxis()->SetTitle(axisAndUnitsSegs.at(j).c_str());
    }
  }

  std::string cmd = "mkdir run" + std::string(runNumber); // + "/" + generalPlot;
  for (auto & generalPlot : general1DPlots) {
    gSystem->Exec((cmd + "/" + generalPlot).c_str());
  }
  for (auto & generalPlot : generalEffPlots) {
    gSystem->Exec((cmd + "/" + generalPlot).c_str());
  }
  for (auto & specificPlot : specific1DPlots) {
    gSystem->Exec((cmd + "/" + specificPlot).c_str());
  }
  for (auto & specificPlot : specific2DPlots) {
    gSystem->Exec((cmd + "/" + specificPlot).c_str());
  }
  for (auto & specificPlot : moreSpecific1DPlots) {
    gSystem->Exec((cmd + "/" + specificPlot).c_str());
  }
  for (auto & specificPlot : moreSpecific1DPlotsSegs) {
    gSystem->Exec((cmd + "/" + specificPlot).c_str());
  }
  for (auto & specificPlot : moreSpecific2DPlots) {
    gSystem->Exec((cmd + "/" + specificPlot).c_str());
  }
  for (auto & specificPlot : moreSpecific2DPlotsSegs) {
    gSystem->Exec((cmd + "/" + specificPlot).c_str());
    //gSystem->Exec("mkdir run" + runNumber + "/" + specificPlot);
  }
/*
  for (auto & generalPlot : generalEffPlots) {
    std::string nameHisto = generalPlot;
    sprintf(name,"%s",nameHisto.c_str());
    m_effs[name] = (TEfficiency*) data1.Get(name);
    m_effs[name]->Draw();
    sprintf(name,"run%s/%s.png",run.c_str(),nameHisto.c_str());
    gPad->SaveAs(name);
    if (fileOK) cout << nameHisto << ".png" << endl;
  } */ 
  for (auto & generalPlot : general1DPlots) {
    std::string nameHisto = generalPlot;
    TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
    sprintf(name,"%s",nameHisto.c_str());
    m_plots[name] = (TH1F*) data1.Get(name);
    m_plots[name]->SetTitle("");
    m_plots[name]->Draw();
    sprintf(name,"run%s/%s/%s.png",run.c_str(),generalPlot.c_str(),nameHisto.c_str());
    DrawPrelimLabel(myCanvas);
    DrawLumiLabel(myCanvas, Lumi);
    SaveCanvas(myCanvas, name);
    delete myCanvas;
    // gPad->SaveAs(name);
  }
 
  //std::vector <std::string> effCats = {"","Q>2"};  
  std::vector <std::string> systems = {"HW","AM","TM"};  
  std::vector <std::string> effCats = {"","Corr","Q>2"};  
  std::map <std::string, std::string> effLeg;
  effLeg[""] = "Every Quality"; 
  effLeg["Corr"] = "Quality #geq 6/8"; 
  effLeg["Q>2"] = "Quality #geq 4/8"; 
  effLeg["hEffHWvsSegX"] = "All BX"; 
  effLeg["hEffHWvsSegXGoodBX"] = "Good BX"; 
  effLeg["hEffHWvsSegT0"] = "All BX"; 
  effLeg["hEffHWvsSegT0GoodBX"] = "Good BX"; 
  effLeg["hEffHWvsph2SegX"] = "All BX"; 
  effLeg["hEffHWvsph2SegXGoodBX"] = "Good BX"; 
  effLeg["hEffHWvsph2SegT0"] = "All BX"; 
  effLeg["hEffHWvsph2SegT0GoodBX"] = "Good BX"; 
  effLeg["hEffHWvsSegXLim"] = "All BX"; 
  effLeg["hEffHWvsSegXLimGoodBX"] = "Good BX"; 
  effLeg["hEffHWvsSegT0Lim"] = "All BX"; 
  effLeg["hEffHWvsSegT0LimGoodBX"] = "Good BX"; 
  effLeg["hEffHWvsph2SegXLim"] = "All BX"; 
  effLeg["hEffHWvsph2SegXLimGoodBX"] = "Good BX"; 
  effLeg["hEffHWvsph2SegT0Lim"] = "All BX"; 
  effLeg["hEffHWvsph2SegT0LimGoodBX"] = "Good BX"; 
  effLeg["hEffAMvsSegX"] = "All BX"; 
  effLeg["hEffAMvsSegXGoodBX"] = "Good BX"; 
  effLeg["hEffAMvsSegT0"] = "All BX"; 
  effLeg["hEffAMvsSegT0GoodBX"] = "Good BX"; 
  effLeg["hEffAMvsph2SegX"] = "All BX"; 
  effLeg["hEffAMvsph2SegXGoodBX"] = "Good BX"; 
  effLeg["hEffAMvsph2SegT0"] = "All BX"; 
  effLeg["hEffAMvsph2SegT0GoodBX"] = "Good BX"; 
  effLeg["hEffAMvsSegXLim"] = "All BX"; 
  effLeg["hEffAMvsSegXLimGoodBX"] = "Good BX"; 
  effLeg["hEffAMvsSegT0Lim"] = "All BX"; 
  effLeg["hEffAMvsSegT0LimGoodBX"] = "Good BX"; 
  effLeg["hEffAMvsph2SegXLim"] = "All BX"; 
  effLeg["hEffAMvsph2SegXLimGoodBX"] = "Good BX"; 
  effLeg["hEffAMvsph2SegT0Lim"] = "All BX"; 
  effLeg["hEffAMvsph2SegT0LimGoodBX"] = "Good BX"; 
  effLeg["hEffHW"] = "HW Q>2"; 
  effLeg["hEffTM"] = "TM"; 
  
  
  std::map <std::string, std::string> effHWCatsTitles; 
  
  effHWCatsTitles["vsSegX"] = "; Phase-1 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsSegXGoodBX"] = "; Phase-1 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsSegXCombi"] = "; Phase-1 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsSegT0"] = "; Phase-1 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsSegT0GoodBX"] = "; Phase-1 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsSegT0Combi"] = "; Phase-1 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsph2SegX"] = "; Phase-2 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsph2SegXGoodBX"] = "; Phase-2 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsph2SegXCombi"] = "; Phase-2 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsph2SegT0"] = "; Phase-2 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsph2SegT0GoodBX"] = "; Phase-2 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsph2SegT0Combi"] = "; Phase-2 Segment t0 (ns); Efficiency"; 
  
  effHWCatsTitles["vsSegXLim"] = "; Phase-1 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsSegXLimGoodBX"] = "; Phase-1 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsSegXLimCombi"] = "; Phase-1 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsSegT0Lim"] = "; Phase-1 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsSegT0LimGoodBX"] = "; Phase-1 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsSegT0LimCombi"] = "; Phase-1 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsph2SegXLim"] = "; Phase-2 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsph2SegXLimGoodBX"] = "; Phase-2 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsph2SegXLimCombi"] = "; Phase-2 Segment Position (cm); Efficiency"; 
  effHWCatsTitles["vsph2SegT0Lim"] = "; Phase-2 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsph2SegT0LimGoodBX"] = "; Phase-2 Segment t0 (ns); Efficiency"; 
  effHWCatsTitles["vsph2SegT0LimCombi"] = "; Phase-2 Segment t0 (ns); Efficiency"; 
  
  // effHWCatsTitles["vsSegX"] = "Eff in All BX vs Seg X; Phase-1 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsSegXGoodBX"] = "Eff in Good BX vs Seg X; Phase-1 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsSegXCombi"] = "Eff All Q vs Seg Position; Phase-1 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsSegT0"] = "Eff in All BX vs Seg t0; Phase-1 Segment t0 (ns); Efficiency"; 
  // effHWCatsTitles["vsSegT0GoodBX"] = "Eff in Good BX vs Seg t0; Phase-1 Segment t0 (ns); Efficiency"; 
  // effHWCatsTitles["vsSegT0Combi"] = "Eff All Q vs Seg t0; Phase-1 Segment t0 (ns); Efficiency"; 
  // effHWCatsTitles["vsph2SegX"] = "Eff in All BX vs ph2Seg X;  Phase-2 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsph2SegXGoodBX"] = "Eff in Good BX vs ph2Seg X;  Phase-2 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsph2SegXCombi"] = "Eff All Q vs ph2Seg Position;  Phase-2 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsph2SegT0"] = "Eff in All BX vs ph2Seg t0;  Phase-2 Segment Position (ns); Efficiency"; 
  // effHWCatsTitles["vsph2SegT0GoodBX"] = "Eff in Good BX vs ph2Seg t0;  Phase-2 Segment t0 (ns); Efficiency"; 
  // effHWCatsTitles["vsph2SegT0Combi"] = "Eff All Q vs ph2Seg t0;  Phase-2 Segment t0 (ns); Efficiency"; 
  
  // effHWCatsTitles["vsSegXLim"] = "Eff in All BX vs Seg X (Limiting t0); Phase-1 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsSegXLimGoodBX"] = "Eff in Good BX vs Seg X (Limiting t0); Phase-1 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsSegXLimCombi"] = "Eff All Q vs Seg X (Limiting t0); Phase-1 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsSegT0Lim"] = "Eff in All BX vs Seg t0 (Limiting X); Phase-1 Segment t0 (ns); Efficiency"; 
  // effHWCatsTitles["vsSegT0LimGoodBX"] = "Eff in Good BX vs Seg t0 (Limiting X); Phase-1 Segment t0 (ns); Efficiency"; 
  // effHWCatsTitles["vsSegT0LimCombi"] = "Eff All Q vs Seg t0 (Limiting X); Phase-1 Segment t0 (ns); Efficiency"; 
  // effHWCatsTitles["vsph2SegXLim"] = "Eff in All BX vs ph2Seg X (Limiting t0);  Phase-2 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsph2SegXLimGoodBX"] = "Eff in Good BX vs ph2Seg X (Limiting t0);  Phase-2 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsph2SegXLimCombi"] = "Eff All Q vs ph2Seg X (Limiting t0);  Phase-2 Segment Position (cm); Efficiency"; 
  // effHWCatsTitles["vsph2SegT0Lim"] = "Eff in All BX vs ph2Seg t0 (Limiting X);  Phase-2 Segment Position (ns); Efficiency"; 
  // effHWCatsTitles["vsph2SegT0LimGoodBX"] = "Eff in Good BX vs ph2Seg t0 (Limiting X);  Phase-2 Segment t0 (ns); Efficiency"; 
  // effHWCatsTitles["vsph2SegT0LimCombi"] = "Eff All Q vs ph2Seg t0 (Limiting X);  Phase-2 Segment t0 (ns); Efficiency"; 

  double mean;  
  char meanStr[40];
  std::map<std::string, float> limit_inf; 
  std::map<std::string, float> limit_sup;
  limit_inf["vsSegX"]=-100;
  limit_inf["vsph2SegX"]=-100;
  limit_sup["vsSegX"]=100;
  limit_sup["vsph2SegX"]=100;
  limit_inf["vsSegT0"]=-12.5;
  limit_inf["vsph2SegT0"]=-12.5;
  limit_sup["vsSegT0"]=12.5;
  limit_sup["vsph2SegT0"]=12.5;
  
  limit_inf["vsSegXLim"]=-100;
  limit_inf["vsph2SegXLim"]=-100;
  limit_sup["vsSegXLim"]=100;
  limit_sup["vsph2SegXLim"]=100;
  limit_inf["vsSegT0Lim"]=-12.5;
  limit_inf["vsph2SegT0Lim"]=-12.5;
  limit_sup["vsSegT0Lim"]=12.5;
  limit_sup["vsph2SegT0Lim"]=12.5;
  float limitInf, limitSup; 
  
  gSystem->Exec("mkdir run" + runNumber + "/" + "hTimeOBDT");
  std::vector<std::string> obdtTags = {"MB1_phi1", "MB1_phi2", "MB2_phi1", "MB2_phi2", "MB3_phi1b", "MB3_phi2b", "MB4_phi1b", "MB4_phi2b","MB4_phi3b", "MB4_phi4b"};
  for (auto & obdtTag : obdtTags) {
    std::string nameHisto = "hTimeOBDT_"  + obdtTag;
    TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
    sprintf(name,"%s",nameHisto.c_str());
    m_plots[name] = (TH1F*) data1.Get(name);
    m_plots[name]->SetTitle("");
    m_plots[name]->Draw();
    sprintf(name,"run%s/hTimeOBDT/%s.png",run.c_str(),nameHisto.c_str());
    // gPad->SaveAs(name);
    DrawPrelimLabel(myCanvas);
    DrawLumiLabel(myCanvas, Lumi);
    SaveCanvas(myCanvas, name);
    delete myCanvas;
  }
  
  gSystem->Exec("mkdir run" + runNumber + "/" + "hSegmentHits");
  
  for (int i = 0; i<chambTags.size(); i++) {
    auto chambTag = chambTags.at(i);

    // HIT PLOTS 
    std::vector <std::string> slTags2 = {"","SL1","SL3"};
    for (auto & slTag : slTags2) {
      std::string nameHisto = "hHitsPerChamber_" + chambTag + slTag;          
      TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
      sprintf(name,"%s",nameHisto.c_str());
      m_plots[name] = (TH1F*) data1.Get(name);
      m_plots[name]->SetTitle("");
      m_plots[name]->Draw();
      sprintf(name,"run%s/hHits/%s.png",run.c_str(),nameHisto.c_str());
      // gPad->SaveAs(name);
      DrawPrelimLabel(myCanvas, chambTag);
      DrawLumiLabel(myCanvas, Lumi);
      SaveCanvas(myCanvas, name);
      delete myCanvas;
    } 
    
    // Segment hits plots
    std::vector <std::vector <std::string>> system_groups = {{"Hw", "Emu", "TM"}, {"Hw", "Emu"}, {"Hw", "TM"}};
    std::map <std::string, std::string> legends = {};
    legends["Hw"] = "Phase-2 Primitives";
    legends["Emu"] = "Phase-2 Emulator";
    legends["TM"] = "Phase-1 Primitives";
    
    std::vector <std::string> quality_groups = {"High", "Low"};
    std::vector <std::string> segment_types = {"", "ph2"};
    int system_group_number = 0;
    for (auto &system_group: system_groups){
      for (auto &segment: segment_types){
        for (auto &quality: quality_groups){
          std::string nameHisto = segment + "SegmentHits_" + chambTag + "_" + quality + "_" + to_string(i);
          TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
          int system_num = 2;
          TLegend *leg = new TLegend(0.7,0.8,0.9,0.9);
          int max_val = -999;
          for (auto &system: system_group){
            nameHisto = "h" + system + quality + "Qual" + segment + "SegNHits_" + chambTag;
            sprintf(name,"%s",nameHisto.c_str());
            m_plots[name] = (TH1F*) data1.Get(name);
            if (m_plots[name] -> GetMaximum() > max_val){
              max_val = m_plots[name] -> GetMaximum();
            }
          }
          for (auto &system: system_group){
            nameHisto = "h" + system + quality + "Qual" + segment + "SegNHits_" + chambTag;
            sprintf(name,"%s",nameHisto.c_str());
            m_plots[name] -> SetTitle("");
            m_plots[name] -> SetLineColor(system_num);
            m_plots[name] -> GetYaxis() -> SetRangeUser(0, 1.2 * max_val);
            m_plots[name] -> GetYaxis()->SetLabelSize(.03);
            leg->AddEntry(m_plots[name], legends[system].c_str(),"l" );
            m_plots[name]->Draw("same");
            system_num++;
          }
          leg->Draw("same");
          nameHisto = segment + "SegmentHits_" + chambTag + "_" + quality + "_" + to_string(system_group_number);
          sprintf(name,"run%s/hSegmentHits/%s.png",run.c_str(),nameHisto.c_str());
          DrawPrelimLabel(myCanvas, chambTag);
          DrawLumiLabel(myCanvas, Lumi);
          SaveCanvas(myCanvas, name);
          delete myCanvas;
        }
      }
      system_group_number++;
    }


    ////////////////////////// EFFICIENCY PLOTS ////////////////////////////

    // ALL vs GOOD BX
    for (auto & system : systems) {
    for (auto & what : effvsWhat) { 
      //if (chambTag == "MB2") continue; 
      char namePassed[128]; 
      char nameTotal[128]; 
      std::string cat = effCats[0];
      std::string nameHisto = "hEff" + system + what + "_" + chambTag;
      TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);

      std::string HWCat = "hEff" + system + what + effWhichBX[0]; // All BX 
      TLegend *leg = new TLegend(0.7,0.8,0.9,0.9);
      nameHisto = HWCat + cat + "_" + chambTag;
      //cout << nameHisto << endl; 
      sprintf(namePassed,"%s",(nameHisto+"passed").c_str());
      sprintf(nameTotal,"%s",(nameHisto+"total").c_str());
      m_plots[namePassed] = (TH1F*) data1.Get(namePassed);
      m_plots[nameTotal] = (TH1F*) data1.Get(nameTotal);
      m_effs[name] = new TEfficiency( *m_plots[namePassed], *m_plots[nameTotal]);
      m_effs[name]->SetLineColor(2);
      limitInf = limit_inf[what]; limitSup = limit_sup[what];
      mean = getMeanEfficiency (m_plots[namePassed], m_plots[nameTotal], limitInf, limitSup);
      sprintf(meanStr,"%.2f", mean);
      
      // leg->AddEntry(m_effs[name], (effLeg[HWCat] + " (" + std::string(meanStr) + ")").c_str(),"l" );
      leg->AddEntry(m_effs[name], (effLeg[HWCat]).c_str(),"l" );
      // m_effs[name]->SetTitle(( system + " " + effHWCatsTitles[what + "Combi"]).c_str());
      m_effs[name]->SetTitle((effHWCatsTitles[what + "Combi"]).c_str());
      m_effs[name]->Draw();
      gPad->Update();
      auto graph =  m_effs[name]->GetPaintedGraph(); 
      graph->SetMinimum(0);
      graph->SetMaximum(1.2);
      gPad->Update();

      HWCat = "hEff" + system + what + effWhichBX[1]; // Good BX
      nameHisto = HWCat + cat + "_" + chambTag;
      sprintf(name,"%s",nameHisto.c_str());
      sprintf(namePassed,"%s",(nameHisto+"passed").c_str());
      sprintf(nameTotal,"%s",(nameHisto+"total").c_str());
      m_plots[namePassed] = (TH1F*) data1.Get(namePassed);
      m_plots[nameTotal] = (TH1F*) data1.Get(nameTotal);
      m_effs[name] = new TEfficiency( *m_plots[namePassed], *m_plots[nameTotal]);
      m_effs[name]->SetLineColor(3);
      limitInf = limit_inf[what]; limitSup = limit_sup[what];
      mean = getMeanEfficiency (m_plots[namePassed], m_plots[nameTotal], limitInf, limitSup);
      sprintf(meanStr,"%.2f", mean);
      // leg->AddEntry(m_effs[name], (effLeg[HWCat] + " (" + std::string(meanStr) + ")").c_str(),"l" );
      leg->AddEntry(m_effs[name], (effLeg[HWCat]).c_str(),"l" );
      // m_effs[name]->SetTitle((system + " " + effHWCatsTitles[what + "Combi"]).c_str());
      m_effs[name]->SetTitle((effHWCatsTitles[what + "Combi"]).c_str());
      m_effs[name]->Draw("same");
      
      TLine l1 = TLine(limitInf, 0, limitInf, 1.2);
      TLine l2 = TLine(limitSup, 0, limitSup, 1.2);
      // l1.Draw("same");
      // l2.Draw("same");

      nameHisto = "hEff" + system + what + "_" + chambTag;
      leg->Draw();
      sprintf(name,"run%s/hEff%s/%s_AllvsGood.png",run.c_str(),system.c_str(),nameHisto.c_str());
      // gPad->SaveAs(name);
      DrawPrelimLabel(myCanvas, chambTag);
      DrawLumiLabel(myCanvas, Lumi);
      SaveCanvas(myCanvas, name);
      delete myCanvas;
    } 
    } // SYSTEMS

    // EFF PER QUALITY
    for (auto & system : systems) {
    for (auto & what : effvsWhat) { 
      //if (chambTag == "MB2") continue; 
      char namePassed[128]; 
      char nameTotal[128]; 
      TEfficiency* pEff = 0;
      
      for (auto & HWCat : effWhichBX){
      if (true) {      
      
      std::string nameHisto = "hEff" + system + what + "_" + chambTag;
      TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
      
      TLegend *leg = new TLegend(0.7,0.8,0.9,0.9);
      std::string cat = effCats[0];
      nameHisto = "hEff" + system + what + HWCat + cat + "_" + chambTag;
      sprintf(name,"%s",nameHisto.c_str());
      sprintf(namePassed,"%s",(nameHisto+"passed").c_str());
      sprintf(nameTotal,"%s",(nameHisto+"total").c_str());
      m_plots[namePassed] = (TH1F*) data1.Get(namePassed);
      m_plots[nameTotal] = (TH1F*) data1.Get(nameTotal);
      m_effs[name] = new TEfficiency( *m_plots[namePassed], *m_plots[nameTotal]);
      m_effs[name]->SetLineColor(2);
      
      limitInf = limit_inf[what]; limitSup = limit_sup[what];
      mean = getMeanEfficiency (m_plots[namePassed], m_plots[nameTotal], limitInf, limitSup);
      sprintf(meanStr,"%.2f", mean);
      // leg->AddEntry(m_effs[name], (effLeg[cat] + " (" + std::string(meanStr) + ")").c_str(),"l" );
      leg->AddEntry(m_effs[name], (effLeg[cat]).c_str(),"l" );
      // m_effs[name]->SetTitle((system + " " + effHWCatsTitles[what+HWCat]).c_str());
      m_effs[name]->SetTitle((effHWCatsTitles[what+HWCat]).c_str());
      m_effs[name]->Draw();
      gPad->Update();
      auto graph =  m_effs[name]->GetPaintedGraph(); 
      graph->SetMinimum(0);
      graph->SetMaximum(1.2);
      gPad->Update();

      cat = effCats[1];
      nameHisto = "hEff" + system + what + HWCat + cat + "_" + chambTag;
      sprintf(name,"%s",nameHisto.c_str());
      sprintf(namePassed,"%s",(nameHisto+"passed").c_str());
      sprintf(nameTotal,"%s",(nameHisto+"total").c_str());
      m_plots[namePassed] = (TH1F*) data1.Get(namePassed);
      m_plots[nameTotal] = (TH1F*) data1.Get(nameTotal);
      m_effs[name] = new TEfficiency( *m_plots[namePassed], *m_plots[nameTotal]);
      m_effs[name]->SetLineColor(3);
      limitInf = limit_inf[what]; limitSup = limit_sup[what];
      mean = getMeanEfficiency (m_plots[namePassed], m_plots[nameTotal], limitInf, limitSup);
      sprintf(meanStr,"%.2f", mean);
      // leg->AddEntry(m_effs[name], (effLeg[cat] + " (" + std::string(meanStr) + ")").c_str(),"l" );
      leg->AddEntry(m_effs[name], (effLeg[cat]).c_str(),"l" );
      m_effs[name]->Draw("same");

      if (system != "TM") { // Q>2 only present in AM and HW
        cat = effCats[2];
        nameHisto = "hEff" + system + what + HWCat + cat + "_" + chambTag;
        sprintf(name,"%s",nameHisto.c_str());
        sprintf(namePassed,"%s",(nameHisto+"passed").c_str());
        sprintf(nameTotal,"%s",(nameHisto+"total").c_str());
        m_plots[namePassed] = (TH1F*) data1.Get(namePassed);
        m_plots[nameTotal] = (TH1F*) data1.Get(nameTotal);
        m_effs[name] = new TEfficiency( *m_plots[namePassed], *m_plots[nameTotal]);
        m_effs[name]->SetLineColor(4);
        limitInf = limit_inf[what]; limitSup = limit_sup[what];
        mean = getMeanEfficiency (m_plots[namePassed], m_plots[nameTotal], limitInf, limitSup);
        sprintf(meanStr,"%.2f", mean);
        // leg->AddEntry(m_effs[name], (effLeg[cat] + " (" + std::string(meanStr) + ")").c_str(),"l" );
        leg->AddEntry(m_effs[name], (effLeg[cat]).c_str(),"l" );
        m_effs[name]->Draw("same");
      }
      nameHisto = "hEff" + system + what + HWCat + "_" + chambTag;
      leg->Draw();
      TLine l1 = TLine(limitInf, 0, limitInf, 1.2);
      TLine l2 = TLine(limitSup, 0, limitSup, 1.2);
      // l1.Draw("same");
      // l2.Draw("same");
      sprintf(name,"run%s/hEff%s/%s_combined.png",run.c_str(),system.c_str(),nameHisto.c_str());
      // gPad->SaveAs(name);
      DrawPrelimLabel(myCanvas, chambTag);
      DrawLumiLabel(myCanvas, Lumi);
      SaveCanvas(myCanvas, name);
      delete myCanvas;
      }
      
      if (true) {
        std::string nameHisto = "hEff" + system + what + "_" + chambTag;
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
      
        TLegend *leg = new TLegend(0.7,0.8,0.9,0.9);
        std::string cat = "Q>2";
        nameHisto = "hEffHW" + what + HWCat + cat + "_" + chambTag;
        sprintf(name,"%s",nameHisto.c_str());
        sprintf(namePassed,"%s",(nameHisto+"passed").c_str());
        sprintf(nameTotal,"%s",(nameHisto+"total").c_str());
        m_plots[namePassed] = (TH1F*) data1.Get(namePassed);
        m_plots[nameTotal] = (TH1F*) data1.Get(nameTotal);
        m_effs[name] = new TEfficiency( *m_plots[namePassed], *m_plots[nameTotal]);
        m_effs[name]->SetLineColor(2);
        limitInf = limit_inf[what]; limitSup = limit_sup[what];
        mean = getMeanEfficiency (m_plots[namePassed], m_plots[nameTotal], limitInf, limitSup);
        sprintf(meanStr,"%.2f", mean);
        // leg->AddEntry(m_effs[name], (effLeg["hEffHW"] + " (" + std::string(meanStr) + ")").c_str(),"l" );
        leg->AddEntry(m_effs[name], (effLeg["hEffHW"]).c_str(),"l" );
      
        m_effs[name]->SetTitle(effHWCatsTitles["hEff" + what + HWCat].c_str());
        m_effs[name]->Draw();
        gPad->Update();
        auto graph =  m_effs[name]->GetPaintedGraph(); 
        graph->SetMinimum(0);
        graph->SetMaximum(1.2);
        gPad->Update();

        cat = "";
        nameHisto = "hEffTM" + what + HWCat + cat + "_" + chambTag;
        sprintf(name,"%s",nameHisto.c_str());
        sprintf(namePassed,"%s",(nameHisto+"passed").c_str());
        sprintf(nameTotal,"%s",(nameHisto+"total").c_str());
        m_plots[namePassed] = (TH1F*) data1.Get(namePassed);
        m_plots[nameTotal] = (TH1F*) data1.Get(nameTotal);
        m_effs[name] = new TEfficiency( *m_plots[namePassed], *m_plots[nameTotal]);
        m_effs[name]->SetTitle(effHWCatsTitles["hEff" + what + HWCat].c_str());
        m_effs[name]->SetLineColor(3);
        limitInf = limit_inf[what]; limitSup = limit_sup[what];
        mean = getMeanEfficiency (m_plots[namePassed], m_plots[nameTotal], limitInf, limitSup);
        sprintf(meanStr,"%.2f", mean);
        // leg->AddEntry(m_effs[name], (effLeg["hEffTM"] + " (" + std::string(meanStr) + ")").c_str(),"l" );
        leg->AddEntry(m_effs[name], (effLeg["hEffTM"]).c_str(),"l" );
        m_effs[name]->Draw("same");
        
        TLine l1 = TLine(limitInf, 0, limitInf, 1.2);
        TLine l2 = TLine(limitSup, 0, limitSup, 1.2);
        // l1.Draw("same");
        // l2.Draw("same"); 
        
        nameHisto = "hEff" + what + HWCat + "_" + chambTag;
        leg->Draw();
        sprintf(name,"run%s/hEffHW/%s_HWTM.png",run.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;

      }

      }
    }
    } 



    for (auto & generalPlot : generalEffPlots) {
      //if (chambTag == "MB2") continue; 
      char namePassed[128]; 
      char nameTotal[128]; 
      for (auto & what : effvsWhat){ 
        for (auto & whichBX : effWhichBX){ 
          std::string nameHisto = generalPlot + what + whichBX + "_" + chambTag;
          TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
          sprintf(name,"%s",nameHisto.c_str());
          sprintf(namePassed,"%s",(nameHisto+"passed").c_str());
          sprintf(nameTotal,"%s",(nameHisto+"total").c_str());
          m_plots[namePassed] = (TH1F*) data1.Get(namePassed);
          m_plots[nameTotal] = (TH1F*) data1.Get(nameTotal);
          m_effs[name] = new TEfficiency( *m_plots[namePassed], *m_plots[nameTotal]);
          m_effs[name]->Draw();
          gPad->Update();
          auto graph =  m_effs[name]->GetPaintedGraph(); 
          graph->SetMinimum(0);
          graph->SetMaximum(1.2);
          gPad->Update();
          sprintf(name,"run%s/%s/%s.png",run.c_str(),generalPlot.c_str(),nameHisto.c_str());
          // gPad->SaveAs(name);
          DrawPrelimLabel(myCanvas, chambTag);
          DrawLumiLabel(myCanvas, Lumi);
          SaveCanvas(myCanvas, name);
          delete myCanvas;
        }
      }
    }



    for (auto & specificPlot : specific1DPlots) {
      std::string nameHisto = specificPlot + "_" + chambTag;
      TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
      sprintf(name,"%s",nameHisto.c_str());
      m_plots[name] = (TH1F*) data1.Get(name);
      m_plots[name]->SetTitle("");
      m_plots[name]->Draw();
      sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
      gPad->SaveAs(name);
      if (specificPlot == "hLatenciesHW" || specificPlot == "hBXWindowHW" || specificPlot == "hMultiplicityFW") {
        gPad->SetLogy();
        sprintf(name,"run%s/%s/%s_log.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
        gPad->SetLogy(0);
      }
    }
    for (auto & specificPlot : specific2DPlots) {
      std::string nameHisto = specificPlot + "_" + chambTag;
      TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
      sprintf(name,"%s",nameHisto.c_str());
      m_plots2[name] = (TH2F*) data1.Get(name);
      m_plots2[name]->SetTitle("");
      if (specificPlot == "h2DHwQualSegNHits" || specificPlot == "h2DEmuQualSegNHits" || specificPlot == "h2DTMQualSegNHits"){
        m_plots2[name]->GetXaxis()->SetNdivisions(5);
        m_plots2[name]->GetYaxis()->SetLabelSize(.05);
      } else {
        m_plots2[name]->GetYaxis()->SetTitleOffset(1.6);
      }
      m_plots2[name]->GetZaxis()->SetLabelSize(.03);
      m_plots2[name]->Draw("colz");
      sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
      // gPad->SaveAs(name);
      DrawPrelimLabel(myCanvas, chambTag);
      DrawLumiLabel(myCanvas, Lumi);
      SaveCanvas(myCanvas, name);
      delete myCanvas;
    }
    for (int j = 0; j<labelTags.size(); j++) {
      auto labelTag = labelTags.at(j);
    //for (const auto & labelTag : labelTags) {

      for (auto & specificPlot : moreSpecific1DPlots) {
        std::string nameHisto = specificPlot + "_" + chambTag + "_" + labelTag;
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        sprintf(name,"%s",nameHisto.c_str());
        m_plots[name] = (TH1F*) data1.Get(name);
        m_plots[name]->SetTitle("");
        m_plots[name]->Draw();
        m_plots_res[specificPlot + "_res_" + chambTag + "_" + categories.at(0)]->SetBinContent(j+1, m_plots[name]->GetRMS(1));
        m_plots_mean[specificPlot + "_mean_" + chambTag + "_" + categories.at(0)]->SetBinContent(j+1, m_plots[name]->GetMean(1));
		m_plots_peak[specificPlot + "_peak_" + chambTag + "_" + categories.at(0)]->SetBinContent(
			j+1, m_plots[name]->GetBinCenter(m_plots[name]->GetMaximumBin()));
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
      
      for (auto & specificPlot : moreSpecific2DPlots) {
        std::string nameHisto = specificPlot + "_" + chambTag + "_" + labelTag;
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        sprintf(name,"%s",nameHisto.c_str());
        m_plots2[name] = (TH2F*) data1.Get(name);
        m_plots2[name]->SetTitle("");
        m_plots2[name]->GetZaxis()->SetLabelSize(.03);
        m_plots2[name]->GetYaxis()->SetTitleOffset(1.6);
        m_plots2[name]->Draw("colz");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
      for (auto & specificPlot : moreSpecific1DPlotsSegs) {
        std::string nameHisto = specificPlot + "_" + chambTag + "_" + labelTag;
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        sprintf(name,"%s",nameHisto.c_str());
        m_plots[name] = (TH1F*) data1.Get(name);
        m_plots[name]->SetTitle("");
        m_plots[name]->Draw();
        m_plots_res[specificPlot + "_res_" + chambTag + "_" + categories.at(0)]->SetBinContent(j+1, m_plots[name]->GetRMS(1));
        m_plots_mean[specificPlot + "_mean_" + chambTag + "_" + categories.at(0)]->SetBinContent(j+1, m_plots[name]->GetMean(1));
		m_plots_peak[specificPlot + "_peak_" + chambTag + "_" + categories.at(0)]->SetBinContent(
			j+1, m_plots[name]->GetBinCenter(m_plots[name]->GetMaximumBin()));
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
      
      for (auto & specificPlot : moreSpecific2DPlotsSegs) {
        std::string nameHisto = specificPlot + "_" + chambTag + "_" + labelTag;
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        sprintf(name,"%s",nameHisto.c_str());
        m_plots2[name] = (TH2F*) data1.Get(name);
        m_plots2[name]-> SetTitle("");
        m_plots2[name]->GetZaxis()->SetLabelSize(.03);
        m_plots2[name]->GetYaxis()->SetTitleOffset(1.6);
        m_plots2[name]->Draw("colz");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
      if (labelTag == "All" || labelTag == "Correlated") continue;
      for (int k = 0; k<slTags.size(); k++) {
        auto slTag = slTags.at(k);
    //  for (auto  slTag : slTags) {
        for (auto & specificPlot : moreSpecific1DPlots) {
          if (specificPlot == "hPsi" || specificPlot == "hTime" || specificPlot == "hPos") continue;
          std::string nameHisto = specificPlot + "_" + chambTag + "_" + labelTag + "_" + slTag;
          TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
          sprintf(name,"%s",nameHisto.c_str());
          m_plots[name] = (TH1F*) data1.Get(name);
          m_plots[name]->SetTitle("");
          m_plots[name]->Draw();
          m_plots_res[specificPlot + "_res_" + chambTag + "_" + categories.at(0)]->SetBinContent(3+1+k, m_plots[name]->GetRMS(1));
          m_plots_mean[specificPlot + "_mean_" + chambTag + "_" + categories.at(0)]->SetBinContent(3+1+k, m_plots[name]->GetMean(1));
		  m_plots_peak[specificPlot + "_peak_" + chambTag + "_" + categories.at(0)]->SetBinContent(
			3+1+k, m_plots[name]->GetBinCenter(m_plots[name]->GetMaximumBin()));
          sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
          // gPad->SaveAs(name);
          DrawPrelimLabel(myCanvas, chambTag);
          DrawLumiLabel(myCanvas, Lumi);
          SaveCanvas(myCanvas, name);
          delete myCanvas;
        }
      
        for (auto & specificPlot : moreSpecific2DPlots) {
          if (specificPlot == "hPsi2D" || specificPlot == "hTime2D" || specificPlot == "hPos2D") continue;
          //if (specificPlot == "hPsi2DTM" ||specificPlot == "hPos2DTM" || specificPlot == "hPhi2DTM" ||specificPlot == "hPhiB2DTM" ) continue;
          std::string nameHisto = specificPlot + "_" + chambTag + "_" + labelTag + "_" + slTag;
          TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
          sprintf(name,"%s",nameHisto.c_str());
          m_plots2[name] = (TH2F*) data1.Get(name);
          m_plots2[name]->SetTitle("");
          m_plots2[name]->GetZaxis()->SetLabelSize(.03);
          m_plots2[name]->GetYaxis()->SetTitleOffset(1.6);
          m_plots2[name]->Draw("colz");
          sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
          // gPad->SaveAs(name);
          DrawPrelimLabel(myCanvas, chambTag);
          DrawLumiLabel(myCanvas, Lumi);
          SaveCanvas(myCanvas, name);
          delete myCanvas;
        }
        for (auto & specificPlot : moreSpecific1DPlotsSegs) {
          if (specificPlot == "hPsi" || specificPlot == "hTime" || specificPlot == "hPos") continue;
          std::string nameHisto = specificPlot + "_" + chambTag + "_" + labelTag + "_" + slTag;
          TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
          sprintf(name,"%s",nameHisto.c_str());
          m_plots[name] = (TH1F*) data1.Get(name);
          m_plots[name]->SetTitle("");
          m_plots[name]->Draw();
          m_plots_res[specificPlot + "_res_" + chambTag + "_" + categories.at(0)]->SetBinContent(3+1+k, m_plots[name]->GetRMS(1));
          m_plots_mean[specificPlot + "_mean_" + chambTag + "_" + categories.at(0)]->SetBinContent(3+1+k, m_plots[name]->GetMean(1));
		  m_plots_peak[specificPlot + "_peak_" + chambTag + "_" + categories.at(0)]->SetBinContent(
			3+1+k, m_plots[name]->GetBinCenter(m_plots[name]->GetMaximumBin()));
          sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
          // gPad->SaveAs(name);
          DrawPrelimLabel(myCanvas, chambTag);
          DrawLumiLabel(myCanvas, Lumi);
          SaveCanvas(myCanvas, name);
          delete myCanvas;
        }
      
        for (auto & specificPlot : moreSpecific2DPlotsSegs) {
          if (specificPlot == "hPsi2D" || specificPlot == "hTime2D" || specificPlot == "hPos2D") continue;
          //if (specificPlot == "hPsi2DTM" ||specificPlot == "hPos2DTM" || specificPlot == "hPhi2DTM" ||specificPlot == "hPhiB2DTM" ) continue;
          std::string nameHisto = specificPlot + "_" + chambTag + "_" + labelTag + "_" + slTag;
          TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
          sprintf(name,"%s",nameHisto.c_str());
          m_plots2[name] = (TH2F*) data1.Get(name);
          m_plots2[name]->SetTitle("");
          m_plots2[name]->GetZaxis()->SetLabelSize(.03);
          m_plots2[name]->GetYaxis()->SetTitleOffset(1.6);
          m_plots2[name]->Draw("colz");
          sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
          // gPad->SaveAs(name);
          DrawPrelimLabel(myCanvas, chambTag);
          DrawLumiLabel(myCanvas, Lumi);
          SaveCanvas(myCanvas, name);
          delete myCanvas;
        }
      } // sl
    } // label
    //for (const auto & quTag : quTags) {
    for (int j = 0; j<quTags.size(); j++) {
      auto quTag = quTags.at(j);
      for (auto & specificPlot : moreSpecific1DPlots) {
        std::string nameHisto = specificPlot + "_" + chambTag + "_" + quTag;
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        sprintf(name,"%s",nameHisto.c_str());
        m_plots[name] = (TH1F*) data1.Get(name);
        m_plots[name]->SetTitle("");
        m_plots[name]->Draw();
        m_plots_res[specificPlot + "_res_" + chambTag + "_" + categories.at(1)]->SetBinContent(j+1, m_plots[name]->GetRMS(1));
        m_plots_mean[specificPlot + "_mean_" + chambTag + "_" + categories.at(1)]->SetBinContent(j+1, m_plots[name]->GetMean(1));
	    m_plots_peak[specificPlot + "_peak_" + chambTag + "_" + categories.at(1)]->SetBinContent(
		  j+1, m_plots[name]->GetBinCenter(m_plots[name]->GetMaximumBin()));
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
      
      for (auto & specificPlot : moreSpecific2DPlots) {
        std::string nameHisto = specificPlot + "_" + chambTag + "_" + quTag;
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        sprintf(name,"%s",nameHisto.c_str());
        m_plots2[name] = (TH2F*) data1.Get(name);
        m_plots2[name]->SetTitle("");
        m_plots2[name]->GetZaxis()->SetLabelSize(.03);
        m_plots2[name]->GetYaxis()->SetTitleOffset(1.6);
        m_plots2[name]->Draw("colz");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
    }
    for (int j = 0; j<quTagsSegs.size(); j++) {
      auto quTag = quTagsSegs.at(j);
      for (auto & specificPlot : moreSpecific1DPlotsSegs) {
        std::string nameHisto = specificPlot + "_" + chambTag + "_" + quTag;
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        sprintf(name,"%s",nameHisto.c_str());
        m_plots[name] = (TH1F*) data1.Get(name);
        m_plots[name]->SetTitle("");
        m_plots[name]->Draw();
        m_plots_res[specificPlot + "_res_" + chambTag + "_" + categories.at(1)]->SetBinContent(j+1, m_plots[name]->GetRMS(1));
        m_plots_mean[specificPlot + "_mean_" + chambTag + "_" + categories.at(1)]->SetBinContent(j+1, m_plots[name]->GetMean(1));
		m_plots_peak[specificPlot + "_peak_" + chambTag + "_" + categories.at(1)]->SetBinContent(
		  j+1, m_plots[name]->GetBinCenter(m_plots[name]->GetMaximumBin()));
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
      
      for (auto & specificPlot : moreSpecific2DPlotsSegs) {
        std::string nameHisto = specificPlot + "_" + chambTag + "_" + quTag;
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        sprintf(name,"%s",nameHisto.c_str());
        m_plots2[name] = (TH2F*) data1.Get(name);
        m_plots2[name]->SetTitle("");
        m_plots2[name]->GetZaxis()->SetLabelSize(.03);
        m_plots2[name]->GetYaxis()->SetTitleOffset(1.6);
        m_plots2[name]->Draw("colz");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specificPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
    } //qu
  } // chamber


  // PLOT RESOLS
 
  for (auto & chambTag : chambTags) {
    for (auto & specific1DPlot : moreSpecific1DPlots) {
      for (int i = 0; i<2; i++){
        std::string nameHisto = specific1DPlot + "_res_" + chambTag + "_" + categories.at(i);
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        m_plots_res[nameHisto]->Draw();
        m_plots_res[nameHisto]->SetTitle("");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specific1DPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
      for (int i = 0; i<2; i++){
        std::string nameHisto = specific1DPlot + "_mean_" + chambTag + "_" + categories.at(i);
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        m_plots_mean[nameHisto]->Draw();
        m_plots_mean[nameHisto]->SetTitle("");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specific1DPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
	  for (int i = 0; i<2; i++){
        std::string nameHisto = specific1DPlot + "_peak_" + chambTag + "_" + categories.at(i);
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        m_plots_peak[nameHisto]->Draw();
        m_plots_peak[nameHisto]->SetTitle("");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specific1DPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
    }
    for (auto & specific1DPlot : moreSpecific1DPlotsSegs) {
      for (int i = 0; i<2; i++){
        std::string nameHisto = specific1DPlot + "_res_" + chambTag + "_" + categories.at(i);
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        m_plots_res[nameHisto]->Draw();
        m_plots_res[nameHisto]->SetTitle("");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specific1DPlot.c_str(),nameHisto.c_str());
        //gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
      for (int i = 0; i<2; i++){
        std::string nameHisto = specific1DPlot + "_mean_" + chambTag + "_" + categories.at(i);
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        m_plots_mean[nameHisto]->Draw();
        m_plots_mean[nameHisto]->SetTitle("");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specific1DPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
	  for (int i = 0; i<2; i++){
        std::string nameHisto = specific1DPlot + "_peak_" + chambTag + "_" + categories.at(i);
        TCanvas* myCanvas = CreateCanvas(nameHisto, false, false);
        m_plots_peak[nameHisto]->Draw();
        m_plots_peak[nameHisto]->SetTitle("");
        sprintf(name,"run%s/%s/%s.png",run.c_str(),specific1DPlot.c_str(),nameHisto.c_str());
        // gPad->SaveAs(name);
        DrawPrelimLabel(myCanvas, chambTag);
        DrawLumiLabel(myCanvas, Lumi);
        SaveCanvas(myCanvas, name);
        delete myCanvas;
      }
    }
  }



} // end macro
